

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="None" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="None" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qutip.stochastic &mdash; QuTiP: Quantum Toolbox in Python 4.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> QuTiP: Quantum Toolbox in Python
          

          
          </a>

          
            
            
              <div class="version">
                4.2
              </div>
            
          

            
            
              <div class="isa_warning">
                <i class="fa fa-warning"></i>
              Update QuTiP to the latest version and check out the latest documentation
              here.
            </div>
            

            
          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
          
          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../frontmatter.html">Frontmatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/guide.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/apidoc.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../biblio.html">Bibliography</a></li>
</ul>

            

          

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QuTiP: Quantum Toolbox in Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>qutip.stochastic</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qutip.stochastic</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># This file is part of QuTiP: Quantum Toolbox in Python.</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (c) 2011 and later, Paul D. Nation and Robert J. Johansson.</span>
<span class="c1">#    All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Redistribution and use in source and binary forms, with or without</span>
<span class="c1">#    modification, are permitted provided that the following conditions are</span>
<span class="c1">#    met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#       this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#       documentation and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1">#    3. Neither the name of the QuTiP: Quantum Toolbox in Python nor the names</span>
<span class="c1">#       of its contributors may be used to endorse or promote products derived</span>
<span class="c1">#       from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1">#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c1">#    &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span>
<span class="c1">#    PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="c1">#    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="c1">#    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="c1">#    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="c1">#    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1">#    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1">#    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">###############################################################################</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">qutip.cy.stochastic</span> <span class="k">import</span> <span class="p">(</span><span class="n">SSESolver</span><span class="p">,</span> <span class="n">SMESolver</span><span class="p">,</span> <span class="n">PcSSESolver</span><span class="p">,</span> <span class="n">PcSMESolver</span><span class="p">,</span>
                                 <span class="n">PmSMESolver</span><span class="p">,</span> <span class="n">GenericSSolver</span><span class="p">,</span> <span class="n">Solvers</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">qutip.qobj</span> <span class="k">import</span> <span class="n">Qobj</span><span class="p">,</span> <span class="n">isket</span><span class="p">,</span> <span class="n">isoper</span><span class="p">,</span> <span class="n">issuper</span>
<span class="kn">from</span> <span class="nn">qutip.states</span> <span class="k">import</span> <span class="n">ket2dm</span>
<span class="kn">from</span> <span class="nn">qutip.solver</span> <span class="k">import</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">qutip.qobjevo</span> <span class="k">import</span> <span class="n">QobjEvo</span>
<span class="kn">from</span> <span class="nn">qutip.superoperator</span> <span class="k">import</span> <span class="p">(</span><span class="n">spre</span><span class="p">,</span> <span class="n">spost</span><span class="p">,</span> <span class="n">mat2vec</span><span class="p">,</span> <span class="n">vec2mat</span><span class="p">,</span>
                                 <span class="n">liouvillian</span><span class="p">,</span> <span class="n">lindblad_dissipator</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">qutip.solver</span> <span class="k">import</span> <span class="n">Options</span><span class="p">,</span> <span class="n">_solver_safety_check</span>
<span class="kn">from</span> <span class="nn">qutip.parallel</span> <span class="k">import</span> <span class="n">serial_map</span>
<span class="kn">from</span> <span class="nn">qutip.ui.progressbar</span> <span class="k">import</span> <span class="n">TextProgressBar</span>
<span class="kn">from</span> <span class="nn">qutip.pdpsolve</span> <span class="k">import</span> <span class="n">main_ssepdpsolve</span><span class="p">,</span> <span class="n">main_smepdpsolve</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ssesolve&#39;</span><span class="p">,</span> <span class="s1">&#39;photocurrent_sesolve&#39;</span><span class="p">,</span> <span class="s1">&#39;smepdpsolve&#39;</span><span class="p">,</span>
           <span class="s1">&#39;smesolve&#39;</span><span class="p">,</span> <span class="s1">&#39;photocurrent_mesolve&#39;</span><span class="p">,</span> <span class="s1">&#39;ssepdpsolve&#39;</span><span class="p">,</span>
           <span class="s1">&#39;stochastic_solvers&#39;</span><span class="p">,</span> <span class="s1">&#39;general_stochastic&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">stochastic_solvers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Available solvers for ssesolve and smesolve</span>
<span class="sd">    euler-maruyama:</span>
<span class="sd">        A simple generalization of the Euler method for ordinary</span>
<span class="sd">        differential equations to stochastic differential equations.</span>
<span class="sd">        Only solver which could take non-commuting sc_ops. *not tested*</span>
<span class="sd">        -Order 0.5</span>
<span class="sd">        -Code: &#39;euler-maruyama&#39;, &#39;euler&#39;, 0.5</span>

<span class="sd">    milstein, Order 1.0 strong Taylor scheme:</span>
<span class="sd">        Better approximate numerical solution to stochastic</span>
<span class="sd">        differential equations.</span>
<span class="sd">        -Order strong 1.0</span>
<span class="sd">        -Code: &#39;milstein&#39;, 1.0</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 10.3 Eq. (3.1), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    milstein-imp, Order 1.0 implicit strong Taylor scheme:</span>
<span class="sd">        Implicit milstein scheme for the numerical simulation of stiff</span>
<span class="sd">        stochastic differential equations.</span>
<span class="sd">        -Order strong 1.0</span>
<span class="sd">        -Code: &#39;milstein-imp&#39;</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 12.2 Eq. (2.9), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    predictor-corrector:</span>
<span class="sd">        Generalization of the trapezoidal method to stochastic</span>
<span class="sd">        differential equations. More stable than explicit methods.</span>
<span class="sd">        -Order strong 0.5, weak 1.0</span>
<span class="sd">        Only the stochastic part is corrected.</span>
<span class="sd">            (alpha = 0, eta = 1/2)</span>
<span class="sd">            -Code: &#39;pred-corr&#39;, &#39;predictor-corrector&#39;, &#39;pc-euler&#39;</span>
<span class="sd">        Both the deterministic and stochastic part corrected.</span>
<span class="sd">            (alpha = 1/2, eta = 1/2)</span>
<span class="sd">            -Code: &#39;pc-euler-imp&#39;, &#39;pc-euler-2&#39;, &#39;pred-corr-2&#39;</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 15.5 Eq. (5.4), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    platen:</span>
<span class="sd">        Explicit scheme, create the milstein using finite difference instead of</span>
<span class="sd">        derivatives. Also contain some higher order terms, thus converge better</span>
<span class="sd">        than milstein while staying strong order 1.0.</span>
<span class="sd">        Do not require derivatives, therefore usable for</span>
<span class="sd">        :func:`qutip.stochastic.general_stochastic`</span>
<span class="sd">        -Order strong 1.0, weak 2.0</span>
<span class="sd">        -Code: &#39;platen&#39;, &#39;platen1&#39;, &#39;explicit1&#39;</span>
<span class="sd">        The Theory of Open Quantum Systems</span>
<span class="sd">        Chapter 7 Eq. (7.47), H.-P Breuer, F. Petruccione</span>

<span class="sd">    rouchon:</span>
<span class="sd">        Scheme keeping the positivity of the density matrix. (smesolve only)</span>
<span class="sd">        -Order strong 1.0?</span>
<span class="sd">        -Code: &#39;rouchon&#39;, &#39;Rouchon&#39;</span>
<span class="sd">        Efficient Quantum Filtering for Quantum Feedback Control</span>
<span class="sd">        Pierre Rouchon, Jason F. Ralph</span>
<span class="sd">        arXiv:1410.5345 [quant-ph]</span>

<span class="sd">    taylor1.5, Order 1.5 strong Taylor scheme:</span>
<span class="sd">        Solver with more terms of the Ito-Taylor expansion.</span>
<span class="sd">        Default solver for smesolve and ssesolve.</span>
<span class="sd">        -Order strong 1.5</span>
<span class="sd">        -Code: &#39;taylor1.5&#39;, &#39;taylor15&#39;, 1.5, None</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 10.4 Eq. (4.6), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    taylor1.5-imp, Order 1.5 implicit strong Taylor scheme:</span>
<span class="sd">        implicit Taylor 1.5 (alpha = 1/2, beta = doesn&#39;t matter)</span>
<span class="sd">        -Order strong 1.5</span>
<span class="sd">        -Code: &#39;taylor1.5-imp&#39;, &#39;taylor15-imp&#39;</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 12.2 Eq. (2.18), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    explicit1.5, Explicit Order 1.5 Strong Schemes:</span>
<span class="sd">        Reproduce the order 1.5 strong Taylor scheme using finite difference</span>
<span class="sd">        instead of derivatives. Slower than taylor15 but usable by</span>
<span class="sd">        :func:`qutip.stochastic.general_stochastic`</span>
<span class="sd">        -Order strong 1.5</span>
<span class="sd">        -Code: &#39;explicit1.5&#39;, &#39;explicit15&#39;, &#39;platen15&#39;</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 11.2 Eq. (2.13), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    taylor2.0, Order 2 strong Taylor scheme:</span>
<span class="sd">        Solver with more terms of the Stratonovich expansion.</span>
<span class="sd">        -Order strong 2.0</span>
<span class="sd">        -Code: &#39;taylor2.0&#39;, &#39;taylor20&#39;, 2.0</span>
<span class="sd">        Numerical Solution of Stochastic Differential Equations</span>
<span class="sd">        Chapter 10.5 Eq. (5.2), By Peter E. Kloeden, Eckhard Platen</span>

<span class="sd">    ---All solvers, except taylor2.0, are usable in both smesolve and ssesolve</span>
<span class="sd">    and for both heterodyne and homodyne. taylor2.0 only work for 1 stochastic</span>
<span class="sd">    operator not dependent of time with the homodyne method.</span>
<span class="sd">    The :func:`qutip.stochastic.general_stochastic` only accept derivatives</span>
<span class="sd">    free solvers: [&#39;euler&#39;, &#39;platen&#39;, &#39;explicit1.5&#39;].</span>

<span class="sd">Available solver for photocurrent_sesolve and photocurrent_mesolve:</span>
<span class="sd">        Photocurrent use ordinary differential equations between</span>
<span class="sd">        stochastic &quot;jump/collapse&quot;.</span>
<span class="sd">    euler:</span>
<span class="sd">        Euler method for ordinary differential equations.</span>
<span class="sd">        Default solver</span>
<span class="sd">        -Order 1.0</span>
<span class="sd">        -Code: &#39;euler&#39;</span>

<span class="sd">    predictor–corrector:</span>
<span class="sd">        predictor–corrector method (PECE) for ordinary differential equations.</span>
<span class="sd">        -Order 2.0</span>
<span class="sd">        -Code: &#39;pred-corr&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="StochasticSolverOptions"><a class="viewcode-back" href="../../apidoc/classes.html#qutip.stochastic.StochasticSolverOptions">[docs]</a><span class="k">class</span> <span class="nc">StochasticSolverOptions</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class of options for stochastic solvers such as</span>
<span class="sd">    :func:`qutip.stochastic.ssesolve`, :func:`qutip.stochastic.smesolve`, etc.</span>

<span class="sd">    The stochastic solvers :func:`qutip.stochastic.general_stochastic`,</span>
<span class="sd">    :func:`qutip.stochastic.ssesolve`, :func:`qutip.stochastic.smesolve`,</span>
<span class="sd">    :func:`qutip.stochastic.photocurrent_sesolve` and</span>
<span class="sd">    :func:`qutip.stochastic.photocurrent_mesolve`</span>
<span class="sd">    all take the same keyword arguments as</span>
<span class="sd">    the constructor of these class, and internally they use these arguments to</span>
<span class="sd">    construct an instance of this class, so it is rarely needed to explicitly</span>
<span class="sd">    create an instance of this class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`, time-dependent Qobj as a list*</span>
<span class="sd">        System Hamiltonian.</span>

<span class="sd">    state0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial state vector (ket) or density matrix.</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    c_ops : list of :class:`qutip.Qobj`, :class:`qutip.QobjEvo` or [Qobj, coeff*]</span>
<span class="sd">        List of deterministic collapse operators.</span>

<span class="sd">    sc_ops : list of :class:`qutip.Qobj`, :class:`qutip.QobjEvo` or [Qobj, coeff*]</span>
<span class="sd">        List of stochastic collapse operators. Each stochastic collapse</span>
<span class="sd">        operator will give a deterministic and stochastic contribution</span>
<span class="sd">        to the equation of motion according to how the d1 and d2 functions</span>
<span class="sd">        are defined.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        Single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    m_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        List of operators representing the measurement operators. The expected</span>
<span class="sd">        format is a nested list with one measurement operator for each</span>
<span class="sd">        stochastic increament, for each stochastic collapse operator.</span>

<span class="sd">    args : dict</span>
<span class="sd">        Dictionary of parameters for time dependent systems.</span>

<span class="sd">    tol : float</span>
<span class="sd">        Tolerance of the solver for implicit methods.</span>

<span class="sd">    ntraj : int</span>
<span class="sd">        Number of trajectors.</span>

<span class="sd">    nsubsteps : int</span>
<span class="sd">        Number of sub steps between each time-spep given in `times`.</span>

<span class="sd">    dW_factors : array</span>
<span class="sd">        Array of length len(sc_ops), containing scaling factors for each</span>
<span class="sd">        measurement operator in m_ops.</span>

<span class="sd">    solver : string</span>
<span class="sd">        Name of the solver method to use for solving the stochastic</span>
<span class="sd">        equations. Valid values are:</span>
<span class="sd">        order 1/2 algorithms: &#39;euler-maruyama&#39;, &#39;pc-euler&#39;, &#39;pc-euler-imp&#39;</span>
<span class="sd">        order 1 algorithms: &#39;milstein&#39;, &#39;platen&#39;, &#39;milstein-imp&#39;, &#39;rouchon&#39;</span>
<span class="sd">        order 3/2 algorithms: &#39;taylor1.5&#39;, &#39;taylor1.5-imp&#39;, &#39;explicit1.5&#39;</span>
<span class="sd">        order 2 algorithms: &#39;taylor2.0&#39;</span>
<span class="sd">        call help of :func:`qutip.stochastic.stochastic_solvers`</span>
<span class="sd">        for a description of the solvers.</span>
<span class="sd">        Implicit methods can adjust tolerance via the kw &#39;tol&#39;</span>
<span class="sd">        default is {&#39;tol&#39;:1e-6}</span>

<span class="sd">    method : string (&#39;homodyne&#39;, &#39;heterodyne&#39;)</span>
<span class="sd">        The name of the type of measurement process that give rise to the</span>
<span class="sd">        stochastic equation to solve.</span>

<span class="sd">    store_all_expect : bool (default False)</span>
<span class="sd">        Whether or not to store the e_ops expect values for all paths.</span>

<span class="sd">    store_measurement : bool (default False)</span>
<span class="sd">        Whether or not to store the measurement results in the</span>
<span class="sd">        :class:`qutip.solver.SolverResult` instance returned by the solver.</span>

<span class="sd">    noise : int, array[int, 1d], array[double, 4d]</span>
<span class="sd">        int : seed of the noise</span>
<span class="sd">        array[int, 1d], length = ntraj, seeds for each trajectories</span>
<span class="sd">        array[double, 4d] (ntraj, len(times), nsubsteps, len(sc_ops)*[1|2])</span>
<span class="sd">            vector for the noise, the len of the last dimensions is doubled for</span>
<span class="sd">            solvers of order 1.5. The correspond to results.noise</span>

<span class="sd">    noiseDepth : int</span>
<span class="sd">        Number of terms kept of the truncated series used to create the</span>
<span class="sd">        noise used by taylor2.0 solver.</span>

<span class="sd">    normalize : bool</span>
<span class="sd">        (default True for (photo)ssesolve, False for (photo)smesolve)</span>
<span class="sd">        Whether or not to normalize the wave function during the evolution.</span>
<span class="sd">        Normalizing density matrices introduce numerical errors.</span>

<span class="sd">    options : :class:`qutip.solver.Options`</span>
<span class="sd">        Generic solver options. Only options.average_states and</span>
<span class="sd">        options.store_states are used.</span>

<span class="sd">    map_func: function</span>
<span class="sd">        A map function or managing the calls to single-trajactory solvers.</span>

<span class="sd">    map_kwargs: dictionary</span>
<span class="sd">        Optional keyword arguments to the map_func function function.</span>

<span class="sd">    progress_bar : :class:`qutip.ui.BaseProgressBar`</span>
<span class="sd">        Optional progress bar class instance.</span>

<span class="sd">    *</span>
<span class="sd">    time-dependent Qobj can be used for H, c_ops and sc_ops.</span>
<span class="sd">    The format for time-dependent system hamiltonian is:</span>
<span class="sd">    H = [Qobj0,[Qobj1,coeff1],[Qobj2,coeff2],...]</span>
<span class="sd">      = Qobj0 + Qobj1 * coeff1(t) + Qobj2 * coeff2(t)</span>

<span class="sd">    coeff function can be:</span>
<span class="sd">        function: coeff(t, args) -&gt; complex</span>
<span class="sd">        str: &quot;sin(1j*w*t)&quot;</span>
<span class="sd">        np.array[complex, 1d] of length equal to the times array</span>
<span class="sd">    The argument args for the function coeff is the args keyword argument of</span>
<span class="sd">        the stochastic solver.</span>
<span class="sd">    Likewisem in str cases, the parameters (&#39;w&#39; in this case) are taken from</span>
<span class="sd">        the args keywords argument.</span>
<span class="sd">    *While mixing coeff type does not results in errors, it is not recommended.*</span>

<span class="sd">    For the collapse operators (c_ops, sc_ops):</span>
<span class="sd">    Each operators can only be composed of 1 Qobj.</span>
<span class="sd">    c_ops = [c_op1, c_op2, ...]</span>
<span class="sd">    where, c_opN = Qobj or [Qobj,coeff]</span>
<span class="sd">    The coeff format is the same as for the Hamiltonian.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">sc_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">state0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">e_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">m_ops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">store_all_expect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">store_measurement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dW_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;homodyne&quot;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsubsteps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntraj</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">generate_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">progress_bar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noiseDepth</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">TextProgressBar</span><span class="p">()</span>

        <span class="c1"># System</span>
        <span class="c1"># Cast to QobjEvo so the code has only one version for both the</span>
        <span class="c1"># constant and time-dependent case.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span>
        <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">QobjEvo</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">tlist</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The hamiltonian format is not valid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">H</span>

        <span class="k">if</span> <span class="n">sc_ops</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sc_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">tlist</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sc_ops</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The sc_ops format is not valid.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                <span class="s2">&quot;[ Qobj / QobjEvo / [Qobj,coeff]]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sc_ops</span> <span class="o">=</span> <span class="n">sc_ops</span>

        <span class="k">if</span> <span class="n">c_ops</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">tlist</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">c_ops</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The c_ops format is not valid.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                <span class="s2">&quot;[ Qobj / QobjEvo / [Qobj,coeff]]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_ops</span> <span class="o">=</span> <span class="n">c_ops</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state0</span> <span class="o">=</span> <span class="n">state0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho0</span> <span class="o">=</span> <span class="n">mat2vec</span><span class="p">(</span><span class="n">state0</span><span class="o">.</span><span class="n">full</span><span class="p">())</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_ops</span> <span class="o">=</span> <span class="n">e_ops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="n">m_ops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_measurement</span> <span class="o">=</span> <span class="n">store_measurement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_all_expect</span> <span class="o">=</span> <span class="n">store_all_expect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_states</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">store_states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="n">dW_factors</span>

        <span class="c1"># Solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">if</span> <span class="n">normalize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">me</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">normalize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">me</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsubsteps</span> <span class="o">=</span> <span class="n">nsubsteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsubsteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntraj</span> <span class="o">=</span> <span class="n">ntraj</span>
        <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="k">elif</span> <span class="s2">&quot;tol&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-7</span>

        <span class="c1"># Noise</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># noise contain a seed</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">,</span> <span class="n">ntraj</span><span class="p">)</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ntraj</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;noise&#39; does not have enought seeds&quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;len(noise) &gt;= ntraj&quot;</span><span class="p">)</span>
                <span class="c1"># numpy seed must be between 0 and 2**32-1</span>
                <span class="c1"># &#39;u4&#39;: unsigned 32bit int</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;u4&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># taylor case not included</span>
                <span class="n">dw_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;heterodyne&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">dw_len_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; * 2&quot;</span> <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;heterodyne&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ntraj</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;noise&#39; does not have the right shape&quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;shape[0] &gt;= ntraj&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;noise&#39; does not have the right shape&quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;shape[1] &gt;= len(times)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nsubsteps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;noise&#39; does not have the right shape&quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;shape[2] &gt;= nsubsteps&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw_len</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;noise&#39; does not have the right shape: &quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;shape[3] &gt;= len(self.sc_ops)&quot;</span> <span class="o">+</span>
                                    <span class="n">dw_len_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">,</span> <span class="n">ntraj</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;u4&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="o">=</span> <span class="n">progress_bar</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntraj</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">map_func</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_func</span> <span class="o">=</span> <span class="n">map_func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_func</span> <span class="o">=</span> <span class="n">serial_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_kwargs</span> <span class="o">=</span> <span class="n">map_kwargs</span> <span class="k">if</span> <span class="n">map_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="c1"># Other</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_solver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">noiseDepth</span>

    <span class="k">def</span> <span class="nf">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;euler-maruyama&#39;</span><span class="p">,</span> <span class="s1">&#39;euler&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;euler-maruyama&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;platen&#39;</span><span class="p">,</span> <span class="s1">&#39;platen1&#39;</span><span class="p">,</span> <span class="s1">&#39;explicit1&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;platen&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pred-corr&#39;</span><span class="p">,</span> <span class="s1">&#39;predictor-corrector&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;pc-euler&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">101</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;pred-corr&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;milstein&#39;</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">102</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;milstein&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;milstein-imp&#39;</span><span class="p">,</span> <span class="mi">103</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">103</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;milstein-imp&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pred-corr-2&#39;</span><span class="p">,</span> <span class="s1">&#39;pc-euler-2&#39;</span><span class="p">,</span> <span class="s1">&#39;pc-euler-imp&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">104</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;pred-corr-2&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Rouchon&#39;</span><span class="p">,</span> <span class="s1">&#39;rouchon&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">120</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;rouchon&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="n">op</span><span class="o">.</span><span class="n">const</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Rouchon only work with constant sc_ops&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;platen15&#39;</span><span class="p">,</span> <span class="s1">&#39;explicit1.5&#39;</span><span class="p">,</span> <span class="s1">&#39;explicit15&#39;</span><span class="p">,</span> <span class="mi">150</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">150</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;explicit1.5&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;taylor15&#39;</span><span class="p">,</span> <span class="s1">&#39;taylor1.5&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">152</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">152</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;taylor1.5&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;taylor15-imp&#39;</span><span class="p">,</span> <span class="s1">&#39;taylor1.5-imp&#39;</span><span class="p">,</span> <span class="mi">153</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">153</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;taylor1.5-imp&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;taylor2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;taylor20&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">202</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">202</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;taylor2.0&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">const</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;homodyne&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Taylor2.0 only work with 1 constant sc_ops &quot;</span> <span class="o">+</span>
                                <span class="s2">&quot;and for homodyne method&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The solver should be one of &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;[None, &#39;euler-maruyama&#39;, &#39;platen&#39;, &#39;pc-euler&#39;, &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&#39;pc-euler-imp&#39;, &#39;milstein&#39;, &#39;milstein-imp&#39;, &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&#39;rouchon&#39;, &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&#39;taylor1.5&#39;, &#39;taylor1.5-imp&#39;, &#39;explicit1.5&#39; &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&#39;taylor2.0&#39;]&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">StochasticSolverOptionsPhoto</span><span class="p">(</span><span class="n">StochasticSolverOptions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    solver : string</span>
<span class="sd">        Name of the solver method to use for solving the evolution</span>
<span class="sd">        of the system.*</span>
<span class="sd">        order 1 algorithms: &#39;euler&#39;</span>
<span class="sd">        order 2 algorithms: &#39;pred-corr&#39;</span>
<span class="sd">        In photocurrent evolution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;euler&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;euler&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pred-corr&#39;</span><span class="p">,</span> <span class="s1">&#39;predictor-corrector&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">=</span> <span class="mi">110</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;pred-corr&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The solver should be one of &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;[None, &#39;euler&#39;, &#39;predictor-corrector&#39;]&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="smesolve"><a class="viewcode-back" href="../../apidoc/functions.html#qutip.stochastic.smesolve">[docs]</a><span class="k">def</span> <span class="nf">smesolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">sc_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">e_ops</span><span class="o">=</span><span class="p">[],</span>
             <span class="n">_safe_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve stochastic master equation. Dispatch to specific solvers</span>
<span class="sd">    depending on the value of the `solver` keyword argument.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`, or time dependent system.</span>
<span class="sd">        System Hamiltonian.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    rho0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial density matrix or state vector (ket).</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    c_ops : list of :class:`qutip.Qobj`, or time dependent Qobjs.</span>
<span class="sd">        Deterministic collapse operator which will contribute with a standard</span>
<span class="sd">        Lindblad type of dissipation.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    sc_ops : list of :class:`qutip.Qobj`, or time dependent Qobjs.</span>
<span class="sd">        List of stochastic collapse operators. Each stochastic collapse</span>
<span class="sd">        operator will give a deterministic and stochastic contribution</span>
<span class="sd">        to the eqaution of motion according to how the d1 and d2 functions</span>
<span class="sd">        are defined.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>

<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;photocurrent&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stochastic solver with photocurrent method has been moved to &quot;</span>
              <span class="s2">&quot;it&#39;s own function: photocurrent_mesolve&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">photocurrent_mesolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="n">c_ops</span><span class="p">,</span> <span class="n">sc_ops</span><span class="o">=</span><span class="n">sc_ops</span><span class="p">,</span>
                                   <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span> <span class="n">_safe_mode</span><span class="o">=</span><span class="n">_safe_mode</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isket</span><span class="p">(</span><span class="n">rho0</span><span class="p">):</span>
        <span class="n">rho0</span> <span class="o">=</span> <span class="n">ket2dm</span><span class="p">(</span><span class="n">rho0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_ops</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="n">e_ops</span>
        <span class="n">e_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">e_ops</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">sso</span> <span class="o">=</span> <span class="n">StochasticSolverOptions</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">state0</span><span class="o">=</span><span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                                  <span class="n">c_ops</span><span class="o">=</span><span class="n">c_ops</span><span class="p">,</span> <span class="n">sc_ops</span><span class="o">=</span><span class="n">sc_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span>
                                  <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_safe_mode</span><span class="p">:</span>
        <span class="n">_safety_checks</span><span class="p">(</span><span class="n">sso</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">==</span> <span class="mi">120</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_positive_map</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">e_ops_dict</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">=</span> <span class="n">liouvillian</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span> <span class="o">+</span> <span class="n">sso</span><span class="o">.</span><span class="n">c_ops</span><span class="p">)</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span>
    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;homodyne&#39;</span> <span class="ow">or</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">())</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as m_ops&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;heterodyne&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m_ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">()]</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">spre</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">spost</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">()))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">spost</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">()))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="n">m_ops</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">):</span>
            <span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">:</span>
                <span class="n">dW_factors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">]</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="n">dW_factors</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;photocurrent&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Moved to &#39;photocurrent_mesolve&#39;&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The method must be one of None, homodyne, heterodyne&quot;</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">153</span><span class="p">]:</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">imp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">imp</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span> <span class="o">=</span> <span class="n">SMESolver</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="s2">&quot;smesolve_&quot;</span> <span class="o">+</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e_ops_dict</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">e_ops_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="ssesolve"><a class="viewcode-back" href="../../apidoc/functions.html#qutip.stochastic.ssesolve">[docs]</a><span class="k">def</span> <span class="nf">ssesolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">sc_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">e_ops</span><span class="o">=</span><span class="p">[],</span>
             <span class="n">_safe_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve stochastic master equation. Dispatch to specific solvers</span>
<span class="sd">    depending on the value of the `solver` keyword argument.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`, or time dependent system.</span>
<span class="sd">        System Hamiltonian.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    psi0 : :class:`qutip.Qobj`</span>
<span class="sd">        State vector (ket).</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    sc_ops : list of :class:`qutip.Qobj`, or time dependent Qobjs.</span>
<span class="sd">        List of stochastic collapse operators. Each stochastic collapse</span>
<span class="sd">        operator will give a deterministic and stochastic contribution</span>
<span class="sd">        to the eqaution of motion according to how the d1 and d2 functions</span>
<span class="sd">        are defined.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>

<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;photocurrent&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stochastic solver with photocurrent method has been moved to &quot;</span>
              <span class="s2">&quot;it&#39;s own function: photocurrent_sesolve&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">photocurrent_sesolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="n">c_ops</span><span class="p">,</span>
                                   <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span> <span class="n">_safe_mode</span><span class="o">=</span><span class="n">_safe_mode</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_ops</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="n">e_ops</span>
        <span class="n">e_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">e_ops</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">sso</span> <span class="o">=</span> <span class="n">StochasticSolverOptions</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">state0</span><span class="o">=</span><span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                                  <span class="n">sc_ops</span><span class="o">=</span><span class="n">sc_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span>
                                  <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_safe_mode</span><span class="p">:</span>
        <span class="n">_safety_checks</span><span class="p">(</span><span class="n">sso</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver_code</span> <span class="o">==</span> <span class="mi">110</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;rouchon only work with smesolve&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;homodyne&#39;</span> <span class="ow">or</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[[</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">()]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;heterodyne&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m_ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">())]</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c1</span><span class="o">.</span><span class="n">dag</span><span class="p">()],</span>
                         <span class="p">[</span><span class="n">c2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">+</span> <span class="n">c2</span><span class="o">.</span><span class="n">dag</span><span class="p">()]]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="n">m_ops</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">):</span>
            <span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">:</span>
                <span class="n">dW_factors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">]</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="n">dW_factors</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;photocurrent&quot;</span><span class="p">:</span>
        <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Moved to &#39;photocurrent_sesolve&#39;&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The method must be one of None, homodyne, heterodyne&quot;</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sso</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">:</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">-=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">sso</span><span class="o">.</span><span class="n">dt</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="p">[[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span> <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span> <span class="o">=</span> <span class="n">SSESolver</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="s2">&quot;ssesolve_&quot;</span> <span class="o">+</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e_ops_dict</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">e_ops_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">_positive_map</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">e_ops_dict</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;homodyne&#39;</span> <span class="ow">or</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sops</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sso</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;heterodyne&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m_ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">dag</span><span class="p">()]</span>
            <span class="n">sops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="n">m_ops</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">):</span>
            <span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">:</span>
                <span class="n">dW_factors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">]</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="n">dW_factors</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The method must be one of homodyne or heterodyne&quot;</span><span class="p">)</span>

    <span class="n">LH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">spre</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">preops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">postops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">preops2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">postops2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_prespostdag</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">*</span> <span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">c_ops</span><span class="p">:</span>
        <span class="n">LH</span> <span class="o">-=</span> <span class="n">op</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">pp</span> <span class="o">+=</span> <span class="n">op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_prespostdag</span><span class="p">)</span><span class="o">.</span><span class="n">_f_norm2</span><span class="p">()</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sops</span><span class="p">):</span>
        <span class="n">LH</span> <span class="o">-=</span> <span class="n">op</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">()))</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span><span class="p">]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">preops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">)]</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">postops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">())]</span>
        <span class="k">for</span> <span class="n">op2</span> <span class="ow">in</span> <span class="n">sops</span><span class="p">[</span><span class="n">i</span><span class="p">:]:</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">preops2</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span> <span class="o">*</span> <span class="n">op2</span><span class="p">)]</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">postops2</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span> <span class="o">*</span> <span class="n">op2</span><span class="o">.</span><span class="n">dag</span><span class="p">())]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">preLH</span> <span class="o">=</span> <span class="n">spre</span><span class="p">(</span><span class="n">LH</span><span class="p">)</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">postLH</span> <span class="o">=</span> <span class="n">spost</span><span class="p">(</span><span class="n">LH</span><span class="o">.</span><span class="n">dag</span><span class="p">())</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">preLH</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">postLH</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">preops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">postops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">preops2</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">postops2</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span> <span class="o">=</span> <span class="n">PmSMESolver</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="s2">&quot;smesolve_&quot;</span> <span class="o">+</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e_ops_dict</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">e_ops_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">photocurrent_mesolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">sc_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">e_ops</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">_safe_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve stochastic master equation using the photocurrent method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`, or time dependent system.</span>
<span class="sd">        System Hamiltonian.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    rho0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial density matrix or state vector (ket).</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    c_ops : list of :class:`qutip.Qobj`, or time dependent Qobjs.</span>
<span class="sd">        Deterministic collapse operator which will contribute with a standard</span>
<span class="sd">        Lindblad type of dissipation.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    sc_ops : list of :class:`qutip.Qobj`, or time dependent Qobjs.</span>
<span class="sd">        List of stochastic collapse operators. Each stochastic collapse</span>
<span class="sd">        operator will give a deterministic and stochastic contribution</span>
<span class="sd">        to the eqaution of motion according to how the d1 and d2 functions</span>
<span class="sd">        are defined.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj` / callback function single</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>

<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">isket</span><span class="p">(</span><span class="n">rho0</span><span class="p">):</span>
        <span class="n">rho0</span> <span class="o">=</span> <span class="n">ket2dm</span><span class="p">(</span><span class="n">rho0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_ops</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="n">e_ops</span>
        <span class="n">e_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">e_ops</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">sso</span> <span class="o">=</span> <span class="n">StochasticSolverOptionsPhoto</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">state0</span><span class="o">=</span><span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                                       <span class="n">c_ops</span><span class="o">=</span><span class="n">c_ops</span><span class="p">,</span> <span class="n">sc_ops</span><span class="o">=</span><span class="n">sc_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_safe_mode</span><span class="p">:</span>
        <span class="n">_safety_checks</span><span class="p">(</span><span class="n">sso</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span> <span class="o">*</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span> <span class="o">=</span> <span class="n">PcSMESolver</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="s2">&quot;photocurrent_mesolve&quot;</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">=</span> <span class="n">liouvillian</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">c_ops</span><span class="o">=</span><span class="n">sso</span><span class="o">.</span><span class="n">c_ops</span><span class="p">)</span> <span class="o">*</span> <span class="n">sso</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">def</span> <span class="nf">_prespostdag</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">*</span> <span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dag</span><span class="p">())</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[[</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span> <span class="o">+</span> <span class="n">spost</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">norm</span><span class="p">()),</span>
                 <span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">norm</span><span class="p">()),</span>
                 <span class="n">op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_prespostdag</span><span class="p">)</span><span class="o">.</span><span class="n">_f_norm2</span><span class="p">()]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">spre</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="p">[[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span> <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">num_collapse</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span> <span class="k">for</span> <span class="n">noise</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">noise</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">e_ops_dict</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">e_ops_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">photocurrent_sesolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">sc_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">e_ops</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">_safe_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve stochastic schrodinger equation using the photocurrent method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`, or time dependent system.</span>
<span class="sd">        System Hamiltonian.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    psi0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial state vector (ket).</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    sc_ops : list of :class:`qutip.Qobj`, or time dependent Qobjs.</span>
<span class="sd">        List of stochastic collapse operators. Each stochastic collapse</span>
<span class="sd">        operator will give a deterministic and stochastic contribution</span>
<span class="sd">        to the eqaution of motion according to how the d1 and d2 functions</span>
<span class="sd">        are defined.</span>
<span class="sd">        Can depend on time, see StochasticSolverOptions help for format.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj` / callback function single</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>

<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_ops</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="n">e_ops</span>
        <span class="n">e_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">e_ops</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">sso</span> <span class="o">=</span> <span class="n">StochasticSolverOptionsPhoto</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">state0</span><span class="o">=</span><span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                                       <span class="n">sc_ops</span><span class="o">=</span><span class="n">sc_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_safe_mode</span><span class="p">:</span>
        <span class="n">_safety_checks</span><span class="p">(</span><span class="n">sso</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span> <span class="o">*</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The len of dW_factors is not the same as sc_ops&quot;</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span> <span class="o">=</span> <span class="n">PcSSESolver</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="s2">&quot;photocurrent_sesolve&quot;</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[[</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">norm</span><span class="p">()]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sso</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">:</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">LH</span> <span class="o">-=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">sso</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">LH</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="p">[[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span> <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">num_collapse</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span> <span class="k">for</span> <span class="n">noise</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">noise</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">e_ops_dict</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">e_ops_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">general_stochastic</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">e_ops</span><span class="o">=</span><span class="p">[],</span> <span class="n">m_ops</span><span class="o">=</span><span class="p">[],</span>
                       <span class="n">_safe_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">len_d2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve stochastic general equation. Dispatch to specific solvers</span>
<span class="sd">    depending on the value of the `solver` keyword argument.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    state0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial state vector (ket) or density matrix as a vector.</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    d1 : function, callable class</span>
<span class="sd">        Function representing the deterministic evolution of the system.</span>

<span class="sd">        def d1(time (double), state (as a np.array vector)):</span>
<span class="sd">            return 1d np.array</span>

<span class="sd">    d2 : function, callable class</span>
<span class="sd">        Function representing the stochastic evolution of the system.</span>

<span class="sd">        def d2(time (double), state (as a np.array vector)):</span>
<span class="sd">            return 2d np.array (N_sc_ops, len(state0))</span>

<span class="sd">    len_d2 : int</span>
<span class="sd">        Number of output vector produced by d2</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>
<span class="sd">        Must be a superoperator if the state vector is a density matrix.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>
<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_ops</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="n">e_ops</span>
        <span class="n">e_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">e_ops</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_ops_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="n">sso</span> <span class="o">=</span> <span class="n">StochasticSolverOptions</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state0</span><span class="o">=</span><span class="n">state0</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                                  <span class="n">e_ops</span><span class="o">=</span><span class="n">e_ops</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only Euler, platen, platen15 can be &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;used for the general stochastic solver&quot;</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">d1</span> <span class="o">=</span> <span class="n">d1</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">d2</span> <span class="o">=</span> <span class="n">d2</span>
    <span class="k">if</span> <span class="n">_safe_mode</span><span class="p">:</span>
        <span class="n">l_vec</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">rho0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_d1</span> <span class="o">=</span> <span class="n">d1</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">rho0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d1(0., mat2vec(state0.full()).ravel()) failed:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d1(0., mat2vec(state0.full()).ravel()) failed&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_d2</span> <span class="o">=</span> <span class="n">d2</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">rho0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d2(0., mat2vec(state0.full()).ravel()) failed:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d2(0., mat2vec(state0.full()).ravel()) failed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_d1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d1 must return an 1d numpy array with &quot;</span><span class="o">+</span>
                            <span class="s2">&quot;the same number of element than the &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;initial state as a vector&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_d2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">out_d2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">and</span> \
                <span class="n">out_d2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">len_d2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d2 must return an 2d numpy array with the shape&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot; (l2_len, len(mat2vec(state0.full()).ravel()) )&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_d1</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;complex128&#39;</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="n">out_d2</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;complex128&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;d1 and d2 must return complex numpy array&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">:</span>
            <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the e_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the e_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">store_measurement</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m_ops</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;General stochastic need explicit &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;m_ops to store measurement&quot;</span><span class="p">)</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="o">=</span> <span class="n">m_ops</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">]</span>
        <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">cm_ops</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The number of dW_factors must fit&quot;</span>
                            <span class="s2">&quot; the number of m_ops&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sso</span><span class="o">.</span><span class="n">dW_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="o">*</span> <span class="n">len_d2</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">sops</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">len_d2</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">QobjEvo</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">]</span>
    <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">ce_ops</span><span class="p">]</span>

    <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span> <span class="o">=</span> <span class="n">GenericSSolver</span>
    <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="s2">&quot;general_stochastic_solver_&quot;</span> <span class="o">+</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver</span>

    <span class="n">ssolver</span> <span class="o">=</span> <span class="n">GenericSSolver</span><span class="p">()</span>
    <span class="c1"># ssolver.set_data(sso)</span>
    <span class="n">ssolver</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="n">sso</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e_ops_dict</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">e_ops_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_safety_checks</span><span class="p">(</span><span class="n">sso</span><span class="p">):</span>
    <span class="n">l_vec</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">rho0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">issuper</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">shape_op</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the hamiltonian does &quot;</span>
                            <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape_op</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the hamiltonian does &quot;</span>
                                <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the hamiltonian does &quot;</span>
                                <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">sc_ops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">issuper</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the sc_ops does &quot;</span>
                                <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the sc_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the sc_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">c_ops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">issuper</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the c_ops does &quot;</span>
                                <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the c_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the c_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">:</span>
        <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the e_ops does &quot;</span>
                                <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the e_ops does &quot;</span>
                                <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sso</span><span class="o">.</span><span class="n">m_ops</span><span class="p">:</span>
            <span class="n">shape_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">me</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the m_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span> <span class="ow">or</span> <span class="n">shape_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l_vec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The size of the m_ops does &quot;</span>
                                    <span class="s2">&quot;not fit the intial state&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sesolve_generic</span><span class="p">(</span><span class="n">sso</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function. See smesolve.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Result</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">times</span>
    <span class="n">data</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">times</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">times</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver_name</span>
    <span class="n">data</span><span class="o">.</span><span class="n">ntraj</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">ntraj</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_expect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">)</span>

    <span class="n">nt</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">ntraj</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">_single_trajectory</span>
    <span class="n">map_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="n">sso</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">}</span>
    <span class="n">map_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">map_kwargs</span><span class="p">)</span>
    <span class="n">task_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">sso</span><span class="p">,)</span>
    <span class="n">task_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">map_func</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">ntraj</span><span class="p">)),</span>
                           <span class="n">task_args</span><span class="p">,</span> <span class="n">task_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">map_kwargs</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">states_list</span><span class="p">,</span> <span class="n">dW</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">expect</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">data</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">states_list</span><span class="p">)</span>
        <span class="n">noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dW</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">expect</span> <span class="o">+=</span> <span class="n">expect</span>
        <span class="n">data</span><span class="o">.</span><span class="n">ss</span> <span class="o">+=</span> <span class="n">expect</span> <span class="o">*</span> <span class="n">expect</span>
    <span class="n">data</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sso</span><span class="o">.</span><span class="n">store_all_expect</span><span class="p">:</span>
        <span class="n">paths_expect</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">paths_expect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">paths_expect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">paths_expect</span><span class="p">)</span>

    <span class="c1"># average density matrices</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">average_states</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
        <span class="n">data</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)])</span><span class="o">.</span><span class="n">unit</span><span class="p">()</span>
                       <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">times</span><span class="p">))]</span>

    <span class="c1"># average</span>
    <span class="n">data</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">expect</span> <span class="o">/</span> <span class="n">nt</span>

    <span class="c1"># standard error</span>
    <span class="k">if</span> <span class="n">nt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ss</span> <span class="o">-</span> <span class="n">nt</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">expect</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">nt</span> <span class="o">*</span> <span class="p">(</span><span class="n">nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># convert complex data to real if hermitian</span>
    <span class="n">data</span><span class="o">.</span><span class="n">expect</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>
                   <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">isherm</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">expect</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
                   <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sso</span><span class="o">.</span><span class="n">e_ops</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_single_trajectory</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sso</span><span class="p">):</span>
    <span class="c1"># Only one step?</span>
    <span class="n">ssolver</span> <span class="o">=</span> <span class="n">sso</span><span class="o">.</span><span class="n">solver_obj</span><span class="p">()</span>
    <span class="c1">#ssolver.set_data(sso)</span>
    <span class="n">ssolver</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="n">sso</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ssolver</span><span class="o">.</span><span class="n">cy_sesolve_single_trajectory</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="c1">#, sso)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># The code for ssepdpsolve have been moved to the file pdpsolve.</span>
<span class="c1"># The call is still in stochastic for consistance.</span>
<div class="viewcode-block" id="ssepdpsolve"><a class="viewcode-back" href="../../apidoc/functions.html#qutip.stochastic.ssepdpsolve">[docs]</a><span class="k">def</span> <span class="nf">ssepdpsolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A stochastic (piecewse deterministic process) PDP solver for wavefunction</span>
<span class="sd">    evolution. For most purposes, use :func:`qutip.mcsolve` instead for quantum</span>
<span class="sd">    trajectory simulations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`</span>
<span class="sd">        System Hamiltonian.</span>

<span class="sd">    psi0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial state vector (ket).</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    c_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        Deterministic collapse operator which will contribute with a standard</span>
<span class="sd">        Lindblad type of dissipation.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj` / callback function single</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>

<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">main_ssepdpsolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># The code for smepdpsolve have been moved to the file pdpsolve.</span>
<span class="c1"># The call is still in stochastic for consistance.</span>
<div class="viewcode-block" id="smepdpsolve"><a class="viewcode-back" href="../../apidoc/functions.html#qutip.stochastic.smepdpsolve">[docs]</a><span class="k">def</span> <span class="nf">smepdpsolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A stochastic (piecewse deterministic process) PDP solver for density matrix</span>
<span class="sd">    evolution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    H : :class:`qutip.Qobj`</span>
<span class="sd">        System Hamiltonian.</span>

<span class="sd">    rho0 : :class:`qutip.Qobj`</span>
<span class="sd">        Initial density matrix.</span>

<span class="sd">    times : *list* / *array*</span>
<span class="sd">        List of times for :math:`t`. Must be uniformly spaced.</span>

<span class="sd">    c_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        Deterministic collapse operator which will contribute with a standard</span>
<span class="sd">        Lindblad type of dissipation.</span>

<span class="sd">    sc_ops : list of :class:`qutip.Qobj`</span>
<span class="sd">        List of stochastic collapse operators. Each stochastic collapse</span>
<span class="sd">        operator will give a deterministic and stochastic contribution</span>
<span class="sd">        to the eqaution of motion according to how the d1 and d2 functions</span>
<span class="sd">        are defined.</span>

<span class="sd">    e_ops : list of :class:`qutip.Qobj` / callback function single</span>
<span class="sd">        single operator or list of operators for which to evaluate</span>
<span class="sd">        expectation values.</span>

<span class="sd">    kwargs : *dictionary*</span>
<span class="sd">        Optional keyword arguments. See</span>
<span class="sd">        :class:`qutip.stochastic.StochasticSolverOptions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    output: :class:`qutip.solver.SolverResult`</span>

<span class="sd">        An instance of the class :class:`qutip.solver.SolverResult`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">main_smepdpsolve</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">rho0</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">c_ops</span><span class="p">,</span> <span class="n">e_ops</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, P.D. Nation, J.R. Johansson, A.J.G. Pitchford, C. Granade, and A.L. Grimsmo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>